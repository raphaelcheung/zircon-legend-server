<!DOCTYPE html>
<html lang="zh-CN" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>玩家管理 - 皓石传奇三管理后台</title>
  <link rel="stylesheet" href="css/themes.css">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div class="app-layout">
    <!-- 侧边栏 -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polygon points="12 2 2 7 12 12 22 7 12 2"></polygon>
            <polyline points="2 17 12 22 22 17"></polyline>
            <polyline points="2 12 12 17 22 12"></polyline>
          </svg>
        </div>
        <span class="sidebar-brand">皓石传奇三</span>
      </div>

      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">主菜单</div>
          <a href="dashboard.html" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="3" width="7" height="9"></rect>
              <rect x="14" y="3" width="7" height="5"></rect>
              <rect x="14" y="12" width="7" height="9"></rect>
              <rect x="3" y="16" width="7" height="5"></rect>
            </svg>
            <span>仪表盘</span>
          </a>
          <a href="players.html" class="nav-item active">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
            <span>玩家管理</span>
          </a>
          <a href="accounts.html" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
            <span>账号管理</span>
          </a>
          <a href="characters.html" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
              <circle cx="8.5" cy="7" r="4"></circle>
              <polyline points="17 11 19 13 23 9"></polyline>
            </svg>
            <span>角色管理</span>
          </a>
        </div>

        <!-- 游戏管理 -->
        <div class="nav-section">
          <div class="nav-section-title">游戏管理</div>
          <a href="items.html" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
              <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
            </svg>
            <span>物品管理</span>
          </a>
          <a href="maps.html" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"></polygon>
              <line x1="8" y1="2" x2="8" y2="18"></line>
              <line x1="16" y1="6" x2="16" y2="22"></line>
            </svg>
            <span>地图管理</span>
          </a>
          <a href="monsters.html" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 2a3 3 0 0 0-3 3v1a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"></path>
              <path d="M19 9v4a7 7 0 0 1-14 0V9"></path>
              <path d="M12 19v3"></path>
              <path d="M8 22h8"></path>
            </svg>
            <span>怪物管理</span>
          </a>
          <a href="npcs.html" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="8" r="5"></circle>
              <path d="M20 21a8 8 0 1 0-16 0"></path>
            </svg>
            <span>NPC管理</span>
          </a>
          <a href="magics.html" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path>
            </svg>
            <span>技能管理</span>
          </a>
          <a href="classes.html" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
              <line x1="10" y1="9" x2="8" y2="9"></line>
            </svg>
            <span>职业管理</span>
          </a>
        </div>

        <!-- 系统 -->
        <div class="nav-section">
          <div class="nav-section-title">系统</div>
          <a href="logs.html" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
              <polyline points="10 9 9 9 8 9"></polyline>
            </svg>
            <span>系统日志</span>
          </a>
          <a href="settings.html" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="3"></circle>
              <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
            <span>设置</span>
          </a>
        </div>
      </nav>
    </aside>

    <!-- 主内容区 -->
    <main class="main-content">
      <header class="topbar">
        <div class="topbar-left">
          <button class="sidebar-toggle" onclick="toggleSidebar()">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="3" y1="12" x2="21" y2="12"></line>
              <line x1="3" y1="6" x2="21" y2="6"></line>
              <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
          </button>
          <h1 class="page-title">在线玩家</h1>
        </div>
        <div class="topbar-right">
          <button class="theme-toggle" onclick="toggleTheme()" data-tooltip="切换主题">
            <svg class="icon-sun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="5"></circle>
              <line x1="12" y1="1" x2="12" y2="3"></line>
              <line x1="12" y1="21" x2="12" y2="23"></line>
              <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
              <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
              <line x1="1" y1="12" x2="3" y2="12"></line>
              <line x1="21" y1="12" x2="23" y2="12"></line>
              <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
              <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
            </svg>
            <svg class="icon-moon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
            </svg>
          </button>
          <div class="user-menu" onclick="toggleUserMenu()">
            <div class="user-avatar" id="userAvatar">A</div>
            <div class="user-info">
              <div class="user-name" id="userName">管理员</div>
              <div class="user-role" id="userRole">SuperAdmin</div>
            </div>
          </div>
        </div>
      </header>

      <div class="page-content">
        <!-- 统计卡片 -->
        <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-bottom: 1.25rem;">
          <div class="stat-card animate-in">
            <div class="stat-card-header">
              <div class="stat-icon success">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                  <circle cx="9" cy="7" r="4"></circle>
                </svg>
              </div>
            </div>
            <div class="stat-value" id="onlineCount">--</div>
            <div class="stat-label">在线玩家</div>
          </div>
        </div>

        <!-- 搜索栏 -->
        <div class="card animate-in" style="margin-bottom: 1.25rem;">
          <div class="card-body" style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 200px;">
              <input type="text" id="searchInput" class="form-input" placeholder="搜索角色名、账号或职业..." onkeyup="handleSearchKeyup(event)">
            </div>
            <button class="btn btn-primary" onclick="doSearch()">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
              </svg>
              搜索
            </button>
            <button class="btn btn-secondary" onclick="resetSearch()">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
                <path d="M3 3v5h5"></path>
              </svg>
              重置
            </button>
            <span id="filterCount" style="color: var(--text-tertiary); font-size: 0.875rem;"></span>
          </div>
        </div>

        <!-- 玩家列表 -->
        <div class="card animate-in animate-delay-1">
          <div class="card-header">
            <h3 class="card-title">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
              </svg>
              在线玩家列表
            </h3>
            <button class="btn btn-ghost btn-sm" onclick="loadPlayers()">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="23 4 23 10 17 10"></polyline>
                <polyline points="1 20 1 14 7 14"></polyline>
                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
              </svg>
              刷新
            </button>
          </div>
          <div class="card-body">
            <div class="table-container">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>角色名</th>
                    <th>账号</th>
                    <th>等级</th>
                    <th>职业</th>
                    <th>当前地图</th>
                    <th>在线时长</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id="playersTable">
                  <tr>
                    <td colspan="7" style="text-align: center; color: var(--text-tertiary);">加载中...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <style>
    .account-link {
      color: var(--primary);
      text-decoration: none;
    }
    .account-link:hover {
      text-decoration: underline;
    }
    .form-input {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: var(--bg-tertiary);
      color: var(--text-primary);
      font-size: 0.875rem;
    }
    .form-input:focus {
      outline: none;
      border-color: var(--primary);
    }
  </style>

  <script src="js/theme.js"></script>
  <script src="js/api.js"></script>
  <script src="js/auth.js"></script>
  <script>
    // 职业中文映射
    const classNameMap = {
      'Warrior': '战士',
      'Wizard': '法师',
      'Taoist': '道士',
      'Assassin': '刺客'
    };

    // 保存完整玩家列表用于搜索
    let allPlayers = [];
    let searchQuery = '';

    document.addEventListener('DOMContentLoaded', async () => {
      if (!checkAuth()) {
        window.location.href = 'index.html';
        return;
      }
      loadUserInfo();
      await loadPlayers();
      setInterval(loadPlayers, 10000);
    });

    function loadUserInfo() {
      const user = getUser();
      if (user) {
        document.getElementById('userName').textContent = user.email.split('@')[0];
        document.getElementById('userRole').textContent = user.identity;
        document.getElementById('userAvatar').textContent = user.email.charAt(0).toUpperCase();
      }
    }

    function handleSearchKeyup(event) {
      if (event.key === 'Enter') {
        doSearch();
      }
    }

    function doSearch() {
      searchQuery = document.getElementById('searchInput').value.toLowerCase().trim();
      renderPlayers(filterPlayers(allPlayers));
    }

    function resetSearch() {
      document.getElementById('searchInput').value = '';
      searchQuery = '';
      renderPlayers(allPlayers);
    }

    function filterPlayers(players) {
      if (!searchQuery) return players;
      return players.filter(player => {
        const charName = (player.characterName || '').toLowerCase();
        const email = (player.accountEmail || '').toLowerCase();
        const classEn = (player.class || '').toLowerCase();
        const classCn = classNameMap[player.class] || '';
        return charName.includes(searchQuery) ||
               email.includes(searchQuery) ||
               classEn.includes(searchQuery) ||
               classCn.includes(searchQuery);
      });
    }

    function getClassName(classEn) {
      return classNameMap[classEn] || classEn;
    }

    async function loadPlayers() {
      try {
        const data = await api.get('/api/players/online');
        document.getElementById('onlineCount').textContent = data.total || 0;
        allPlayers = data.players || [];
        renderPlayers(filterPlayers(allPlayers));
      } catch (error) {
        console.error('加载玩家列表失败:', error);
        document.getElementById('playersTable').innerHTML =
          '<tr><td colspan="7" style="text-align: center; color: var(--error);">加载失败</td></tr>';
      }
    }

    function renderPlayers(players) {
      const tbody = document.getElementById('playersTable');
      const filterCountEl = document.getElementById('filterCount');

      // 显示过滤结果数量
      if (searchQuery && allPlayers.length > 0) {
        filterCountEl.textContent = `显示 ${players.length} / ${allPlayers.length}`;
      } else {
        filterCountEl.textContent = '';
      }

      if (players.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; color: var(--text-tertiary);">${searchQuery ? '未找到匹配的玩家' : '暂无在线玩家'}</td></tr>`;
        return;
      }

      tbody.innerHTML = players.map(player => `
        <tr>
          <td><strong>${escapeHtml(player.characterName)}</strong></td>
          <td><a href="accounts.html?search=${encodeURIComponent(player.accountEmail)}" class="account-link">${escapeHtml(player.accountEmail)}</a></td>
          <td>${player.level}</td>
          <td><span class="badge badge-primary">${getClassName(player.class)}</span></td>
          <td>${escapeHtml(player.mapName)}</td>
          <td>${formatOnlineTime(player.onlineTime)}</td>
          <td>
            <button class="btn btn-error btn-sm" onclick="kickPlayer('${escapeHtml(player.characterName)}')">
              踢出
            </button>
          </td>
        </tr>
      `).join('');
    }

    function formatOnlineTime(minutes) {
      if (minutes < 60) {
        return Math.round(minutes) + ' 分钟';
      }
      const hours = Math.floor(minutes / 60);
      const mins = Math.round(minutes % 60);
      return `${hours} 小时 ${mins} 分钟`;
    }

    async function kickPlayer(name) {
      if (!confirm(`确定要踢出玩家 "${name}" 吗？`)) {
        return;
      }

      try {
        await api.post(`/api/players/${encodeURIComponent(name)}/kick`);
        alert(`已踢出玩家 "${name}"`);
        await loadPlayers();
      } catch (error) {
        alert('操作失败: ' + error.message);
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('collapsed');
    }

    function toggleUserMenu() {
      if (confirm('确定要退出登录吗？')) {
        logout();
        window.location.href = 'index.html';
      }
    }
  </script>
</body>
</html>
